import arcade

WINDOW_WIDTH = 800
WINDOW_HEIGHT = 600
WINDOW_TITLE = "Pacman Game"
TILE_SIZE = 32
PLAYER_SPEED = 200

LEVEL_MAP = [
    "WWWWWWWWWWWWWWWWWWWWWWW",
    "W.........W.........W.W",
    "W.WWW.WWW.W.WWW.WWW.W.W",
    "W.W...W...W.W...W...W.W",
    "W.W.W.W.WWW.W.W.W.W.W.W",
    "W...W.....P.....W...W.W",
    "WWW.W.WWW.WWW.W.W.WWW.W",
    "W.....W...G...W.....W.W",
    "W.WWW.W.WWW.W.W.WWW.W.W",
    "W.W...W.....W.W...W...W",
    "W.W.W.WWWWWWW.W.W.W.W.W",
    "W...G.....W.....G.....W",
    "WWWWWWWWWWWWWWWWWWWWWWW"
]

class Character(arcade.Sprite):
    def __init__(self, x, y, color, radius=None):
        super().__init__()
        if radius is None:
            radius = TILE_SIZE // 2 - 2
        texture = arcade.make_circle_texture(radius * 2, color)
        self.texture = texture
        self.width = texture.width
        self.height = texture.height
        self.center_x = x
        self.center_y = y
        self.change_x = 0
        self.change_y = 0

# --- Game View ---
class PacmanGame(arcade.View):
    def __init__(self):
        super().__init__()
        self.wall_list = arcade.SpriteList()
        self.coin_list = arcade.SpriteList()
        self.ghost_list = arcade.SpriteList()
        self.player_list = arcade.SpriteList()
        self.player = None
        self.score = 0
        self.lives = 3
        self.game_over = False
        self.background_color = arcade.color.BLACK

    def setup(self):
        self.wall_list = arcade.SpriteList()
        self.coin_list = arcade.SpriteList()
        self.ghost_list = arcade.SpriteList()
        self.player_list = arcade.SpriteList()
        self.game_over = False
        self.score = 0
        self.lives = 3

        rows = len(LEVEL_MAP)
        for row_idx, row in enumerate(LEVEL_MAP):
            for col_idx, cell in enumerate(row):
                x = col_idx * TILE_SIZE + TILE_SIZE / 2
                y = (rows - row_idx - 1) * TILE_SIZE + TILE_SIZE / 2

                if cell == "W":
                    wall = arcade.Sprite()
                    wall.texture = arcade.make_soft_square_texture(
                        32, arcade.color.BLUE, outer_alpha=255
                    )
                    wall.center_x = x
                    wall.center_y = y
                    self.wall_list.append(wall)

                elif cell == ".":
                    coin = arcade.Sprite()
                    coin.texture = arcade.make_circle_texture(TILE_SIZE // 4, arcade.color.YELLOW)
                    coin.center_x = x
                    coin.center_y = y
                    self.coin_list.append(coin)

                elif cell == "G":
                    ghost = Character(x, y, arcade.color.RED, radius=TILE_SIZE//2)
                    self.ghost_list.append(ghost)

                elif cell == "P":
                    self.player = Character(x, y, arcade.color.YELLOW, radius=28//2)
                    self.player_list.append(self.player)

    def on_draw(self):
        self.clear()
        self.wall_list.draw()
        self.coin_list.draw()
        self.ghost_list.draw()
        self.player_list.draw()
        arcade.draw_text(f"SCORE: {self.score}", 10, WINDOW_HEIGHT - 30, arcade.color.WHITE, 24)
        arcade.draw_text(f"LIVES: {self.lives}", 10, WINDOW_HEIGHT - 55, arcade.color.WHITE, 24)

        if self.game_over:
            arcade.draw_text("GAME OVER", WINDOW_WIDTH//2, WINDOW_HEIGHT//2,
                             arcade.color.RED, 50, anchor_x="center")

    def on_key_press(self, key, modifiers):
        if key == arcade.key.UP:
            self.player.change_y = PLAYER_SPEED
        elif key == arcade.key.DOWN:
            self.player.change_y = -PLAYER_SPEED
        elif key == arcade.key.LEFT:
            self.player.change_x = -PLAYER_SPEED
        elif key == arcade.key.RIGHT:
            self.player.change_x = PLAYER_SPEED

    def on_key_release(self, key, modifiers):
        if key in (arcade.key.UP, arcade.key.DOWN):
            self.player.change_y = 0
        if key in (arcade.key.LEFT, arcade.key.RIGHT):
            self.player.change_x = 0

    def on_update(self, delta_time):
        if self.game_over:
            return

        # Move player
        self.player.center_x += self.player.change_x * delta_time
        self.player.center_y += self.player.change_y * delta_time

        # Wall collisions
        if arcade.check_for_collision_with_list(self.player, self.wall_list):
            self.player.center_x -= self.player.change_x * delta_time
            self.player.center_y -= self.player.change_y * delta_time

        # Coin collection
        coins_hit = arcade.check_for_collision_with_list(self.player, self.coin_list)
        for coin in coins_hit:
            coin.remove_from_sprite_lists()
            self.score += 10  # Update score

        # Ghost collision
        ghosts_hit = arcade.check_for_collision_with_list(self.player, self.ghost_list)
        if ghosts_hit:
            self.lives -= 1
            # Reset player to start
            for row_idx, row in enumerate(LEVEL_MAP):
                for col_idx, cell in enumerate(row):
                    if cell == "P":
                        x = col_idx * TILE_SIZE + TILE_SIZE / 2
                        y = (len(LEVEL_MAP) - row_idx - 1) * TILE_SIZE + TILE_SIZE / 2
                        self.player.center_x = x
                        self.player.center_y = y
                        self.player.change_x = 0
                        self.player.change_y = 0
                        break

            if self.lives <= 0:
                self.game_over = True

def main():
    window = arcade.Window(WINDOW_WIDTH, WINDOW_HEIGHT, WINDOW_TITLE)
    game = PacmanGame()
    game.setup()
    window.show_view(game)
    arcade.run()

if __name__ == "__main__":
    main()


